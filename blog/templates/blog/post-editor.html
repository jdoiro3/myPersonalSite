{% extends "blog/post.html" %}

{% block head %}
{% load static %}
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
<link rel="stylesheet" type="text/css" href="{% static 'blog/post.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'blog/post-editor.css' %}">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  const UPLOAD_IMAGE_ENDPOINT = "{% url 'blog:add-image' %}";
  const DELETE_IMAGE_ENDPOINT = "{% url 'blog:delete-image' %}";
  const USER_ID = "{{ request.user.id }}";
  const POST_ID = "{{ post.id }}";
</script>
<script src="{% static 'blog/post-editor.js' %}" defer></script>
{% endblock %}

{% block post_title %}
<div>
  <!-- add a header image button -->
  <button id="add-header-image" class="toolbar-item" type="button" title="add header image">
    <i class="fas fa-image"></i>
  </button>
  <input style="display: none;" id="add-header-image-input" type="file" accept="image/*" name="header-image" onchange="uploadImage(this, addImageToHeader)">
  <!-- this stores the header's image id when a new image is uploaded via the fetch API -->
  <input style="display: none;" id="header-image-id" type="number" form="save-changes" name="header-image-id" {% if post.title_image is not None %}value={{ post.title_image.id }}{% else %}value="-1"{% endif %}></input>
</div>
<input id="title" form="save-changes" value="{{ post.title }}" name="title" oninput="updateSaveAction()" required></input>
{% endblock %}
<!-- we don't want to include social media sharing buttons while editing -->
{% block sharing %}{% endblock %}

{% block user_select %}
<div class="selector">
  <label for="user">Post Author:</label>
  <select name="user" id="user" form="save-changes">
    {% for user in users %}
    <option value="{{ user.id }}" {% if post.author == user %}selected="selected"{% endif %}>{{ user.username }}</option>
    {% endfor %}
  </select>
</div>
{% endblock %}

{% block post_content %}
<div id="selectors-container">
  <!-- selector for the post's status -->
  <div class="selector">
    <label for="status">Post Status:</label>
    <select name="status" id="status" class="toolbar-item" form="save-changes">
      <option value="0" {% if post.status == None or post.status == 0 %}selected="selected"{% endif %}>Draft</option>
      <option value="1" {% if post.status == 1 %}selected="selected"{% endif %}>Publish</option>
    </select>
  </div>
  <!-- selector for the post's category -->
  <div class="selector">
    <label for="category">Post Category:</label>
    <select name="category" id="category" class="toolbar-item" form="save-changes" required>
      {% if post.category == None %}<option label=" " style="display: none;" selected="selected"></option>{% endif %}
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if post.category == cat %}selected="selected"{% endif %}>{{ cat }}</option>
      {% endfor %}
    </select>
  </div>
</div>
<div id="edit-toolbar">
  <!-- save changes form -->
  <form id="save-changes" action="{% url 'blog:post-detail' post.slug %}" method="post">
    {% csrf_token %}
    <input type="hidden" {% if post.id %}value="{{ post.id }}"{% else %}value="-1"{% endif %} name="post-id" id="post-id">
    <button id="save" class="toolbar-item" type="submit" title="save changes"><i class="fas fa-share-square"></i></button>
  </form>
  {% if post.id %}
  <!-- delete post form -->
  <form onsubmit="return confirm('Are you sure you want to delete this post?');" action="{% url 'blog:delete-post' post.id %}">
    <button id="delete" class="toolbar-item" type="submit" title="delete post"><i class="fas fa-trash-alt"></i></button>
  </form>
  {% endif %}
  <!-- add image to post button -->
  <button id="add-image-button" class="toolbar-item" type="button" title="add image to post"><i class="fas fa-image"></i></button>
  <input style="display: none;" id="add-image-input" class="toolbar-item" type="file" accept="image/*" name="image" onchange="uploadImage(this, addImageToPost)">
  <!-- view and edit post images uploaded -->
  <button type="button" class="toolbar-item" data-toggle="modal" data-target="#post-images-form" title="view and edit uploaded images"><i class="fas fa-images"></i></button>
  <!-- add quote button. displays a form -->
  <button type="button" class="toolbar-item" data-toggle="modal" data-target="#quote-form" title="add quote to post"><i class="fas fa-quote-left"></i></button>
</div>
<div class="flex-container-content">
  <div id="markdown-editor-container"><textarea spellcheck="true" id="markdown-editor" cols=120 form="save-changes" name="markdown">{{ post.content }}</textarea></div>
  <div id="content"></div>
</div>
{% endblock %}

{% block additions %}
<!-- add quote Bootstrap Modal -->
<div class="modal fade" id="quote-form" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title" id="exampleModalLabel">Add Blockquote to Post</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form class="form-container">
        <div class="modal-body">
          <div class="form-group">
            <label for="quote">Quote</label>
            <textarea id="quote" class="form-control form-control-sm mb-3" rows="3" placeholder="Enter quote"></textarea>
          </div>
          <div class="form-group">
            <label for="citation">Citation</label>
            <input type="text" class="form-control" id="citation" placeholder="Citation">
          </div>
          <div class="form-group">
            <label for="citation-url">Link to Source</label>
            <input type="url" class="form-control" id="citation-url" placeholder="url">
          </div>
        </div>
        <div class="modal-footer border-top-0 d-flex justify-content-center">
          <button type="button" class="btn btn-success" onclick="addQuote()">Add Quote</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- post images Bootstrap Modal -->
<div class="modal fade" id="post-images-form" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Uploaded Post Images</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div id="images-container">
            {% if image_chunks %}
              {% for chunk in image_chunks %}
                <div class="row" {% if forloop.last %}id="last-row"{% else %}id="row-{{ forloop.counter }}"{% endif %}>
                  {% for image in chunk %}
                    <div class="image-container" id="image-container-{{ image.id }}">
                        <img class="img-fluid rounded" src='{{ image.image.url }}'>
                        <a class="remove-image" id="{{ image.id }}"><i class="fas fa-trash-alt"></i></a>
                        <!-- copy the images url to the clipboard -->
                        <input type="text" value="{{ image.image.url }}" id="url-{{ image.id }}" style="display: none;">
                        <div class="mytooltip" id="tooltip-{{ image.id }}">
                          <button class="toolbar-item" onclick="copyUrl('url-{{ image.id }}', 'tooltip-{{ image.id }}-text')" onmouseout="outFunc('tooltip-{{ image.id }}-text')">
                            <span class="tooltiptext" id="tooltip-{{ image.id }}-text">Copy to clipboard</span>
                            <i class="fas fa-link"></i>
                          </button>
                        </div>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% else %}
              <div class="row" id="last-row"></div>
            {% endif %}
              <button id="add-image-to-modal-button"><i class="fas fa-plus"></i></button>
              <input style="display: none;" id="add-image-to-modal-input" class="toolbar-item" type="file" accept="image/*" name="image" onchange="uploadImage(this, addImageToUploadedModal)">
          </div>
      </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}